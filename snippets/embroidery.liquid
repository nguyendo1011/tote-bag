{% comment %}
  Embroidery Customization Component
  Usage: {% render 'embroidery', product: product %}
{% endcomment %}

{% liquid
  assign store_has_embroidery_opts = false
  assign product_has_embroidery_opts = false

  # Check if setup collection embroidery and has products
  assign embroidery_products = settings.embroidery_products
  if embroidery_products.size > 0
    assign store_has_embroidery_opts = true
  endif

  # Check if product has embroidery options
  assign product_embroidery_mtf = product.metafields.custom.embroidery_options.value
  if product_embroidery_mtf.size > 0
    assign product_has_embroidery_opts = true
  endif

  # Get other information
  assign min_price = 0
  assign character_limit = product.metafields.custom.embroidery_letter_limit | default: 12
%}

{% comment %} Fast return if no embroidery options are available {% endcomment %}
{% if store_has_embroidery_opts == false or product_has_embroidery_opts == false %}{% break %}{% endif %}

{% capture options %}
  {% assign skip_options = '' %}
  {% for embroidery_product in product_embroidery_mtf %}

    {% if forloop.first and skip_options == '' %}
      <div class="tw-flex tw-flex-col tw-gap-2">
       <span for="embroidery-name"><input
        type="text"
        id="embroidery-name"
        data-embroidery-name
        maxlength="{{ character_limit }}"
        placeholder="e.g., John Smith"
        class="tw-w-full tw-px-4 tw-py-2 tw-text-base tw-border tw-border-gray-400 tw-rounded-[4px]"
      >
      <p>{{ "products.product.embroidery.settings.add_character_limit" | t: character_limit: character_limit }}
        <span class="tw-text-gray-500 tw-font-normal ml-auto">
        (<span data-name-length>0</span>/<span data-name-max>12</span>)
      </span></p>
     </span>
       </div>
    {% endif %}

    {% assign embroidery_product_min_price = embroidery_product.min_price %}
    {% if min_price < embroidery_product_min_price %}
      {% assign min_price = embroidery_product_min_price %}
    {% endif %}
    {% for option in embroidery_product.product.options_with_values %}
      {% if skip_options contains option.name %}
        {% continue %}
      {% endif %}

      {% assign skip_options = skip_options | append: option.name | append: ',' %}

      <div class="tw-flex tw-flex-col tw-gap-3">
        <span class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">
          {{ option.name }}
        </span>

        <div class="tw-flex tw-flex-wrap tw-gap-3" data-option-name="{{ option.name | handleize }}" data-product-id="{{ product.id }}">
          {% for value in option.values %}
            {% assign current_variant = embroidery_product.product.variants | where: option.name, value | first %}
            <h1>color_pattern: {{ shop.metaobjects['shopify--color-pattern'][150922526851] }}</h1>
            {% if option.name == 'Color' %}
              {% assign color_hex = '#000000' %}
              {% if current_variant %}
                {% assign color_hex = current_variant.metafields.custom.color_hex.value | default: color_hex %}
              {% endif %}
              <label for="embroidery-{{ product.id }}-{{ option.name | handleize }}" class="tw-flex tw-flex-col tw-items-center tw-gap-1 tw-cursor-pointer">
                <input
                  type="radio"
                  id="embroidery-{{ product.id }}-{{ option.name | handleize }}"
                  name="embroidery-{{ product.id }}-{{ option.name | handleize }}"
                  value="{{ value }}"
                  {% if current_variant %}data-variant-id="{{ current_variant.id }}"{% endif %}
                  data-option-name="{{ option.name | handleize }}"
                  data-product-id="{{ product.id }}"
                  class="tw-sr-only"
                >
                <button
                  type="button"
                  class="tw-relative tw-w-10 tw-h-10 tw-rounded-full tw-transition-all tw-ring-1 tw-ring-gray-300 hover:tw-ring-gray-400 tw-border-2 tw-border-transparent"
                  style="background-color: {{ color_hex }}"
                  data-option-value="{{ value }}"
                >
                  <svg class="tw-w-5 tw-h-5 tw-text-white tw-drop-shadow-lg tw-hidden tw-absolute tw-inset-0 tw-m-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </button>
                <span class="tw-text-xs tw-text-gray-600">{{ value }}</span>
              </label>
            {% else %}
              <label for="embroidery-{{ product.id }}-{{ option.name | handleize }}" class="tw-cursor-pointer">
                <input
                  type="radio"
                  id="embroidery-{{ product.id }}-{{ option.name | handleize }}"
                  name="embroidery-{{ product.id }}-{{ option.name | handleize }}"
                  value="{{ value }}"
                  {% if current_variant %}data-variant-id="{{ current_variant.id }}"{% endif %}
                  data-option-name="{{ option.name | handleize }}"
                  data-product-id="{{ product.id }}"
                  class="tw-sr-only"
                >
                <span class="tw-inline-block tw-px-4 tw-py-2 tw-text-sm tw-font-medium tw-text-center tw-border-2 tw-border-gray-300 hover:tw-border-gray-400 tw-rounded-lg tw-transition-all tw-bg-white">
                  {{ value }}
                </span>
              </label>
            {% endif %}
        {% endfor %}

        </div>
      </div>
    {% endfor %}
    
  {% endfor %}
{% endcapture %}

<accordion-element class="embroidery-accordion">

  <!-- Accordion Toggle/Header -->
  <div class="embroidery-toggle" data-accordion-toggle>
    <label class="tw-flex tw-items-center tw-cursor-pointer tw-py-4">
      <input
        type="checkbox"
        data-accordion-trigger
        data-embroidery-checkbox
        class="tw-w-5 tw-h-5 tw-bg-gray-100 tw-border-gray-300 tw-rounded tw-transition-colors tw-cursor-pointer"
      >
      <span class="tw-ml-3 tw-text-base tw-font-medium tw-text-gray-900 tw-flex-1">
        {{ 'products.product.embroidery.settings.add_heading' | t }}
      </span>
      <span class="tw-text-sm tw-text-gray-600" data-embroidery-price>
        +{{ min_price | money }}
      </span>
    </label>
  </div>

  <!-- Accordion Body (Collapsible Content) -->
  <div class="embroidery-body" data-accordion-body>
    <embroidery-customizer class="tw-block">
      <div class="tw-pl-8 tw-pb-6 tw-border-l-2 tw-border-gray-200 tw-space-y-6">

        {{ options }}

      <!-- Preview Text -->
      <div class="tw-p-6 tw-bg-gray-50 tw-rounded-lg tw-border tw-border-gray-200" data-preview-container>
        <p class="tw-text-xs tw-text-gray-500 tw-mb-2 tw-uppercase tw-tracking-wide">Preview</p>
        <p
          class="tw-text-2xl tw-font-medium tw-text-center"
          data-preview-text
          style="font-family: Georgia, serif; color: #000000"
        ></p>
      </div>

    </div>
    </embroidery-customizer>
  </div>
</accordion-element>

<script src="{{ 'accordion.js' | asset_url }}" defer></script>
<script src="{{ 'embroidery.js' | asset_url }}" defer></script>

<style>
  .embroidery-toggle.is-open {
    /* Optional: Add any styles for open state */
  }
</style>
